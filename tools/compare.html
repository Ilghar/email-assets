<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Compare Tool</title>
  <style>
    :root { --gap: 10px; --bar: 42px; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .bar { position: sticky; top: 0; z-index: 10; background: #111; color: #fff; padding: 6px 10px; display: grid; grid-template-columns: 1fr 1fr auto auto auto auto; gap: 8px; align-items: center; }
    .bar input[type="text"] { width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid #333; background: #1e1e1e; color: #ddd; }
    .bar label { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: #ccc; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); height: calc(100vh - var(--bar)); padding: var(--gap); box-sizing: border-box; }
    .pane { position: relative; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; }
    .pane header { position: absolute; top: 6px; left: 6px; right: 6px; display: flex; gap: 8px; justify-content: space-between; align-items: center; z-index: 2; }
    .pane header .controls { display: inline-flex; gap: 8px; align-items: center; background: rgba(255,255,255,0.85); padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; }
    .pane iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; transform-origin: top left; background: white; }
  .pane pre.source { position: absolute; inset: 0; margin: 0; padding: 16px; width: 100%; height: 100%; overflow: auto; background: #0f1115; color: #d0d4db; font: 12px/18px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; -moz-tab-size: 2; tab-size: 2; white-space: pre; }
    .hidden { display: none !important; }
    .zoom-val { min-width: 44px; text-align: right; font-variant-numeric: tabular-nums; }
    .hint { color: #aaa; font-size: 12px; }
    @media (prefers-color-scheme: dark) {
      body { background: #0e0e0f; color: #ddd; }
      .pane { border-color: #333; background: #1a1a1a; }
      .pane header .controls { background: rgba(0,0,0,0.5); border-color: #444; }
    }
  </style>
</head>
<body>
  <div class="bar">
  <input id="srcA" type="text" placeholder="Relative path to file A (e.g. ../backups/email-layout-to-compare.html)" />
  <input id="srcB" type="text" placeholder="Relative path to file B (e.g. ../kimi-vs-code-optimized-email-final.html)" />
    <label title="Rendered preview vs source code"><select id="mode"><option value="rendered">Rendered</option><option value="source">Source</option></select></label>
    <label title="Keep the two panes scrolled together"><input id="sync" type="checkbox" /> Sync scroll</label>
    <button id="load">Load</button>
    <a id="openExternal" class="hint" href="#" target="_blank">Open both in external browser</a>
  </div>
  <div class="grid">
    <div class="pane" id="paneA">
      <header>
        <div class="controls">
          <span>Zoom A</span>
          <input id="zoomA" type="range" min="50" max="200" value="100" aria-label="Zoom A" title="Zoom A" />
          <span class="zoom-val" id="zoomAVal">100%</span>
        </div>
      </header>
  <iframe id="frameA" title="Preview A" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
  <pre id="codeA" class="source hidden"></pre>
    </div>
    <div class="pane" id="paneB">
      <header>
        <div class="controls">
          <span>Zoom B</span>
          <input id="zoomB" type="range" min="50" max="200" value="100" aria-label="Zoom B" title="Zoom B" />
          <span class="zoom-val" id="zoomBVal">100%</span>
        </div>
      </header>
  <iframe id="frameB" title="Preview B" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
  <pre id="codeB" class="source hidden"></pre>
    </div>
  </div>

  <script>
    // Warn when opened via file://, recommend Live Preview for same-origin iframes
    if (location.protocol === 'file:') {
      const warn = document.createElement('div');
      warn.style.cssText = 'position:fixed;bottom:10px;left:10px;right:10px;background:#fff3cd;color:#856404;border:1px solid #ffeeba;padding:8px 12px;border-radius:6px;z-index:9999;font-size:12px';
      warn.textContent = 'Tip: For synced scrolling and full features, open this page with Live Preview (embedded) so iframes share the same origin.';
      document.body.appendChild(warn);
      setTimeout(() => warn.remove(), 8000);
    }
    const qs = new URLSearchParams(location.search);
    const $ = (s) => document.querySelector(s);
  const srcA = $('#srcA');
  const srcB = $('#srcB');
  const frameA = $('#frameA');
  const frameB = $('#frameB');
  const codeA = $('#codeA');
  const codeB = $('#codeB');
    const sync = $('#sync');
    const openExternal = $('#openExternal');
  const modeSel = $('#mode');

    const WORKSPACE_ROOT = '/Users/ilghar_studio/Desktop/CODING/Repository-direction-vscode/email-assets';

    function toRelativeWithinWorkspace(value) {
      if (!value) return value;
      if (value.startsWith('http://') || value.startsWith('https://') || value.startsWith('file://')) {
        return value;
      }
      const trimmed = value.trim();
      if (trimmed.startsWith(WORKSPACE_ROOT)) {
        let relative = trimmed.slice(WORKSPACE_ROOT.length);
        if (relative.startsWith('/')) relative = relative.slice(1);
        return relative;
      }
      return trimmed;
    }

  // Load initial from query params (fall back to curated defaults)
  // Left: original/baseline; Right: current/updated
  srcA.value = toRelativeWithinWorkspace(qs.get('a')) || '../backups/email-layout-to-compare.html';
  srcB.value = toRelativeWithinWorkspace(qs.get('b')) || '../kimi-vs-code-optimized-email-final.html';
  // Sync scroll default (query param sync=1 to force on, sync=0 to force off). Default: on.
  const syncParam = qs.get('sync');
  sync.checked = syncParam === null ? true : syncParam === '1' || syncParam === 'true';
  // Mode default via query (?mode=source) else rendered
  const modeParam = qs.get('mode');
  modeSel.value = modeParam === 'source' ? 'source' : 'rendered';

    function makeLoadable(value) {
      if (!value) return '';
      const trimmed = value.trim();
      if (!trimmed) return '';
      if (trimmed.startsWith('http://') || trimmed.startsWith('https://') || trimmed.startsWith('file://')) {
        return trimmed;
      }
      if (location.protocol === 'file:') {
        const abs = trimmed.startsWith('/') ? trimmed : `${WORKSPACE_ROOT}/${trimmed}`;
        return `file://${abs}`;
      }
      // When served by Live Preview (http), leave relative to allow the server to resolve inside workspace
      return trimmed;
    }

    function setModeVisibility(mode) {
      const showSource = mode === 'source';
      frameA.classList.toggle('hidden', showSource);
      frameB.classList.toggle('hidden', showSource);
      codeA.classList.toggle('hidden', !showSource);
      codeB.classList.toggle('hidden', !showSource);
    }

    async function loadSources() {
      const aPath = srcA.value.trim();
      const bPath = srcB.value.trim();
      if (!aPath || !bPath) return;
      try {
        const [aRes, bRes] = await Promise.all([
          fetch(aPath, { cache: 'no-store' }),
          fetch(bPath, { cache: 'no-store' })
        ]);
        const [aText, bText] = await Promise.all([aRes.text(), bRes.text()]);
        codeA.textContent = aText;
        codeB.textContent = bText;
      } catch (e) {
        codeA.textContent = `Failed to load ${aPath}: ${e}`;
        codeB.textContent = `Failed to load ${bPath}: ${e}`;
      }
      const base = location.origin + location.pathname.replace(/\/[^/]*$/, '/');
      const syncVal = sync.checked ? '1' : '0';
      openExternal.href = `${base}?a=${encodeURIComponent(srcA.value)}&b=${encodeURIComponent(srcB.value)}&sync=${syncVal}&mode=source`;
    }

    function loadFrames() {
      const a = makeLoadable(srcA.value);
      const b = makeLoadable(srcB.value);
      if (a) frameA.src = a;
      if (b) frameB.src = b;
      const base = location.origin + location.pathname.replace(/\/[^/]*$/, '/');
      if (srcA.value && srcB.value) {
        const syncVal = sync.checked ? '1' : '0';
        openExternal.href = `${base}?a=${encodeURIComponent(srcA.value)}&b=${encodeURIComponent(srcB.value)}&sync=${syncVal}&mode=rendered`;
      } else {
        openExternal.href = '#';
      }
    }

    function reload() {
      setModeVisibility(modeSel.value);
      if (modeSel.value === 'source') {
        loadSources();
      } else {
        loadFrames();
      }
    }
    $('#load').addEventListener('click', reload);

    // Update URL when user sets sources
    function updateQuery() {
      const next = new URL(location.href);
      if (srcA.value) next.searchParams.set('a', srcA.value); else next.searchParams.delete('a');
      if (srcB.value) next.searchParams.set('b', srcB.value); else next.searchParams.delete('b');
      next.searchParams.set('mode', modeSel.value);
      history.replaceState({}, '', next);
    }
    srcA.addEventListener('change', () => { updateQuery(); reload(); });
    srcB.addEventListener('change', () => { updateQuery(); reload(); });
    modeSel.addEventListener('change', () => { updateQuery(); reload(); });

    // Independent zoom per pane (CSS scale)
    function setZoom(frame, val, label) {
      const scale = val / 100;
      frame.style.transform = `scale(${scale})`;
      frame.style.width = `${100/scale}%`;
      frame.style.height = `${100/scale}%`;
      label.textContent = `${val}%`;
    }
    $('#zoomA').addEventListener('input', (e) => setZoom(frameA, e.target.value, $('#zoomAVal')));
    $('#zoomB').addEventListener('input', (e) => setZoom(frameB, e.target.value, $('#zoomBVal')));
    setZoom(frameA, 100, $('#zoomAVal'));
    setZoom(frameB, 100, $('#zoomBVal'));

    // Sync scroll between iframes or source panes (same-origin for iframes; always for code)
    function bindSync(a, b) {
      let lock = false;
      function handler(src, dst) {
        if (!sync.checked || lock) return;
        try {
          // iframes mode
          const sDoc = src.contentDocument;
          const dDoc = dst.contentDocument;
          const sEl = sDoc ? (sDoc.scrollingElement || sDoc.documentElement) : src;
          const dEl = dDoc ? (dDoc.scrollingElement || dDoc.documentElement) : dst;
          const ratio = sEl.scrollTop / (sEl.scrollHeight - sEl.clientHeight || 1);
          lock = true;
          dEl.scrollTop = ratio * (dEl.scrollHeight - dEl.clientHeight);
          lock = false;
        } catch (e) {
          // Cross-origin; ignore.
        }
      }
      // iframes scroll
      a.addEventListener('load', () => { a.contentWindow?.addEventListener('scroll', () => handler(a, b), { passive: true }); });
      b.addEventListener('load', () => { b.contentWindow?.addEventListener('scroll', () => handler(b, a), { passive: true }); });
      // code panes scroll
      codeA.addEventListener('scroll', () => handler(codeA, codeB), { passive: true });
      codeB.addEventListener('scroll', () => handler(codeB, codeA), { passive: true });
    }
    bindSync(frameA, frameB);

    // Auto-load if query params present
    if (srcA.value || srcB.value) reload();
  </script>
</body>
</html>
